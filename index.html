<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>English Speaking Practice</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ™ï¸ English Speaking Practice</h1>
        <p class="subtitle">Luyá»‡n NÃ³i Tiáº¿ng Anh - American English</p>
      </div>

      <div class="welcome-section">
        <h2>ChÃ o má»«ng báº¡n! ğŸ‘‹</h2>
        <p>
          ChÆ°Æ¡ng trÃ¬nh luyá»‡n nÃ³i tiáº¿ng Anh <strong>giá»ng Má»¹</strong> sáº½ giÃºp báº¡n
          thá»±c hÃ nh tráº£ lá»i cÃ¡c cÃ¢u há»i. Má»—i cÃ¢u há»i báº¡n sáº½ cÃ³
          <strong>50 giÃ¢y</strong> Ä‘á»ƒ tráº£ lá»i. HÃ£y láº¯ng nghe cÃ¢u há»i vÃ  tráº£ lá»i
          to báº±ng tiáº¿ng Anh.
        </p>
        <p style="margin-top: 10px">
          <strong>HÆ°á»›ng dáº«n:</strong> Chá»n bÃ i há»c â†’ Chá»n giá»ng Ä‘á»c (Æ°u tiÃªn
          giá»ng Má»¹) â†’ Nháº¥n Start â†’ Láº¯ng nghe vÃ  tráº£ lá»i má»—i cÃ¢u há»i.
        </p>
      </div>

      <div class="lesson-selector">
        <button class="lesson-btn" data-lesson="1">
          ğŸ“ BÃ€I 1: Báº¢N THÃ‚N<br />
          <small>(6 cÃ¢u há»i)</small>
        </button>
        <button class="lesson-btn" data-lesson="2">
          ğŸ’¼ BÃ€I 2: CÃ”NG VIá»†C<br />
          <small>(15 cÃ¢u há»i)</small>
        </button>
      </div>

      <div class="practice-area">
        <div class="voice-controls">
          <div class="voice-control-group">
            <label>ğŸ”Š Chá»n giá»ng Ä‘á»c (Æ¯u tiÃªn giá»ng Má»¹ ğŸ‡ºğŸ‡¸):</label>
            <select id="voiceSelect">
              <option>Äang táº£i giá»ng Ä‘á»c...</option>
            </select>
          </div>
          <div class="voice-control-group">
            <label>âš¡ Tá»‘c Ä‘á»™ Ä‘á»c: <span id="speedValue">1.0x</span></label>
            <input
              type="range"
              id="speedControl"
              min="0.5"
              max="2"
              step="0.1"
              value="1"
            />
          </div>
        </div>

        <div class="progress-section">
          <div class="progress-info">
            <span>Tiáº¿n Ä‘á»™</span>
            <span id="progressText">0/0</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>

        <div class="status-indicator" id="statusIndicator"></div>

        <div class="question-display" id="questionDisplay">
          <div class="question-number" id="questionNumber"></div>
          <div class="question-text" id="questionText">
            Nháº¥n Start Ä‘á»ƒ báº¯t Ä‘áº§u
          </div>
        </div>

        <div class="timer-display">
          <div class="timer-label">Thá»i gian cÃ²n láº¡i</div>
          <div class="timer-value" id="timerValue">50</div>
        </div>

        <div class="controls">
          <button class="control-btn btn-start" id="startBtn">â–¶ï¸ Start</button>
          <button class="control-btn btn-pause" id="pauseBtn" disabled>
            â¸ï¸ Pause
          </button>
          <button class="control-btn btn-stop" id="stopBtn" disabled>
            â¹ï¸ Stop
          </button>
        </div>

        <div
          class="completion-message"
          id="completionMessage"
          style="display: none"
        >
          <h2>ğŸ‰ Xuáº¥t sáº¯c!</h2>
          <p>Báº¡n Ä‘Ã£ hoÃ n thÃ nh bÃ i há»c!</p>
          <button class="restart-btn" id="restartBtn">ğŸ”„ LÃ m láº¡i</button>
        </div>
      </div>
    </div>

    <script>
      const lessons = {
        1: {
          title: "Báº¢N THÃ‚N",
          questions: [
            "What's your name?",
            "How old are you?",
            "Where are you from?",
            "Where do you live?",
            "What do you do for a living?",
            "Where do you work?",
          ],
        },
        2: {
          title: "CÃ”NG VIá»†C",
          questions: [
            "Do you work or study?",
            "What do you do for a living?",
            "Where do you work?",
            "What's your department?",
            "How many people are there in your department?",
            "Are your colleagues friendly?",
            "Is your boss easy-going?",
            "What do you do at work?",
            "How many days off do you have a week?",
            "What days do you work?",
            "What time do you start work?",
            "What time do you get off work?",
            "Do you work the night shift?",
            "How far is it from your house to your workplace?",
            "How long does it take you to get to your workplace?",
          ],
        },
      };

      let currentLesson = null;
      let currentQuestionIndex = 0;
      let timer = null;
      let timeRemaining = 50;
      let isPaused = false;
      let isRunning = false;
      let synth = window.speechSynthesis;
      let voices = [];
      let sortedVoices = [];
      let currentUtterance = null;

      // Elements
      const lessonBtns = document.querySelectorAll(".lesson-btn");
      const practiceArea = document.querySelector(".practice-area");
      const questionNumber = document.getElementById("questionNumber");
      const questionText = document.getElementById("questionText");
      const timerValue = document.getElementById("timerValue");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const statusIndicator = document.getElementById("statusIndicator");
      const startBtn = document.getElementById("startBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const stopBtn = document.getElementById("stopBtn");
      const completionMessage = document.getElementById("completionMessage");
      const restartBtn = document.getElementById("restartBtn");
      const voiceSelect = document.getElementById("voiceSelect");
      const speedControl = document.getElementById("speedControl");
      const speedValue = document.getElementById("speedValue");

      // Load and prioritize voices
      function loadVoices() {
        voices = synth.getVoices();

        // Filter English voices and categorize by priority
        const usVoices = [];
        const ukVoices = [];
        const otherEnVoices = [];

        voices.forEach((voice) => {
          if (voice.lang.startsWith("en-US")) {
            usVoices.push(voice);
          } else if (voice.lang.startsWith("en-GB")) {
            ukVoices.push(voice);
          } else if (voice.lang.startsWith("en")) {
            otherEnVoices.push(voice);
          }
        });

        // Combine in priority order: US -> UK -> Other
        sortedVoices = [...usVoices, ...ukVoices, ...otherEnVoices];

        // Populate select dropdown
        voiceSelect.innerHTML = "";

        if (sortedVoices.length === 0) {
          voiceSelect.innerHTML =
            "<option>No English voices available</option>";
        } else {
          sortedVoices.forEach((voice, index) => {
            const option = document.createElement("option");
            option.value = index;

            // Add badge based on voice type
            let badge = "";
            if (voice.lang.startsWith("en-US")) {
              badge = " ğŸ‡ºğŸ‡¸ [Recommended]";
            } else if (voice.lang.startsWith("en-GB")) {
              badge = " ğŸ‡¬ğŸ‡§";
            }

            option.textContent = `${voice.name} (${voice.lang})${badge}`;

            // Auto-select first US voice (index 0 if available)
            if (index === 0) {
              option.selected = true;
            }

            voiceSelect.appendChild(option);
          });
        }
      }

      // Load voices when available
      if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = loadVoices;
      }

      // Initial load
      setTimeout(loadVoices, 100);

      speedControl.addEventListener("input", (e) => {
        speedValue.textContent = e.target.value + "x";
      });

      // Lesson selection
      lessonBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const lessonNum = parseInt(btn.dataset.lesson);
          selectLesson(lessonNum);
        });
      });

      function selectLesson(lessonNum) {
        currentLesson = lessons[lessonNum];
        currentQuestionIndex = 0;

        lessonBtns.forEach((btn) => {
          btn.classList.toggle(
            "active",
            parseInt(btn.dataset.lesson) === lessonNum
          );
        });

        practiceArea.classList.add("active");
        resetPractice();
        updateProgress();
      }

      function resetPractice() {
        stopTimer();
        synth.cancel();
        isRunning = false;
        isPaused = false;
        timeRemaining = 50;
        currentQuestionIndex = 0;

        questionText.textContent = "Nháº¥n Start Ä‘á»ƒ báº¯t Ä‘áº§u";
        questionNumber.textContent = "";
        timerValue.textContent = "50";
        timerValue.classList.remove("warning");
        statusIndicator.style.display = "none";
        completionMessage.style.display = "none";

        startBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;

        updateProgress();
      }

      function updateProgress() {
        const total = currentLesson.questions.length;
        const current = currentQuestionIndex;
        const percentage = (current / total) * 100;

        progressBar.style.width = percentage + "%";
        progressText.textContent = `${current}/${total}`;
      }

      function speak(text) {
        return new Promise((resolve, reject) => {
          synth.cancel();

          currentUtterance = new SpeechSynthesisUtterance(text);

          // Use selected voice from prioritized list
          const selectedIndex = parseInt(voiceSelect.value);
          if (sortedVoices[selectedIndex]) {
            currentUtterance.voice = sortedVoices[selectedIndex];
          }

          currentUtterance.rate = parseFloat(speedControl.value);
          currentUtterance.pitch = 1;
          currentUtterance.volume = 1;

          currentUtterance.onend = resolve;
          currentUtterance.onerror = reject;

          synth.speak(currentUtterance);
        });
      }

      function showQuestion() {
        const question = currentLesson.questions[currentQuestionIndex];
        questionNumber.textContent = `CÃ¢u há»i ${currentQuestionIndex + 1}/${
          currentLesson.questions.length
        }`;
        questionText.textContent = question;

        statusIndicator.style.display = "block";
        statusIndicator.className = "status-indicator status-speaking";
        statusIndicator.textContent = "ğŸ”Š Äang Ä‘á»c cÃ¢u há»i...";

        speak(question)
          .then(() => {
            if (isRunning && !isPaused) {
              startTimer();
            }
          })
          .catch((error) => {
            console.error("Speech error:", error);
            if (isRunning && !isPaused) {
              startTimer();
            }
          });
      }

      function startTimer() {
        timeRemaining = 50;
        timerValue.textContent = timeRemaining;
        timerValue.classList.remove("warning");

        statusIndicator.className = "status-indicator status-waiting";
        statusIndicator.textContent =
          "â±ï¸ Thá»i gian tráº£ lá»i - HÃ£y nÃ³i cÃ¢u tráº£ lá»i cá»§a báº¡n!";

        timer = setInterval(() => {
          if (!isPaused) {
            timeRemaining--;
            timerValue.textContent = timeRemaining;

            if (timeRemaining <= 10) {
              timerValue.classList.add("warning");
            }

            if (timeRemaining <= 0) {
              stopTimer();
              nextQuestion();
            }
          }
        }, 1000);
      }

      function stopTimer() {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
      }

      function nextQuestion() {
        currentQuestionIndex++;
        updateProgress();

        if (currentQuestionIndex >= currentLesson.questions.length) {
          completeLesson();
        } else {
          showQuestion();
        }
      }

      function completeLesson() {
        isRunning = false;
        stopTimer();
        synth.cancel();

        document.querySelector(".question-display").style.display = "none";
        document.querySelector(".timer-display").style.display = "none";
        document.querySelector(".controls").style.display = "none";
        statusIndicator.style.display = "none";
        completionMessage.style.display = "block";

        startBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
      }

      // Control buttons
      startBtn.addEventListener("click", () => {
        if (!isRunning) {
          isRunning = true;
          isPaused = false;
          currentQuestionIndex = 0;

          document.querySelector(".question-display").style.display = "flex";
          document.querySelector(".timer-display").style.display = "block";
          document.querySelector(".controls").style.display = "flex";
          completionMessage.style.display = "none";

          startBtn.disabled = true;
          pauseBtn.disabled = false;
          stopBtn.disabled = false;

          updateProgress();
          showQuestion();
        }
      });

      pauseBtn.addEventListener("click", () => {
        if (isRunning) {
          isPaused = !isPaused;

          if (isPaused) {
            synth.pause();
            pauseBtn.textContent = "â–¶ï¸ Resume";
            statusIndicator.textContent = "â¸ï¸ ÄÃ£ táº¡m dá»«ng";
          } else {
            synth.resume();
            pauseBtn.textContent = "â¸ï¸ Pause";
            if (timer) {
              statusIndicator.className = "status-indicator status-waiting";
              statusIndicator.textContent =
                "â±ï¸ Thá»i gian tráº£ lá»i - HÃ£y nÃ³i cÃ¢u tráº£ lá»i cá»§a báº¡n!";
            } else {
              statusIndicator.className = "status-indicator status-speaking";
              statusIndicator.textContent = "ğŸ”Š Äang Ä‘á»c cÃ¢u há»i...";
            }
          }
        }
      });

      stopBtn.addEventListener("click", () => {
        if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n dá»«ng bÃ i há»c?")) {
          resetPractice();
        }
      });

      restartBtn.addEventListener("click", () => {
        resetPractice();
      });
    </script>
  </body>
</html>
